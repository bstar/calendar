import { Meta, Source, Story, Canvas } from '@storybook/addon-docs/blocks';
import { CLACalendar } from './CLACalendar';
import * as CalendarStories from './CLACalendar.stories';
import * as LayerStories from './LayersAndNavigation.stories';
import * as RestrictionStories from './Restrictions.stories';
import * as EnhancedStories from './EnhancedEvents.stories';

<Meta title="Documentation/Usage Examples & Patterns" />

# CLACalendar Usage Examples & Patterns

This guide provides practical examples and common usage patterns for implementing the CLACalendar component in different scenarios.

## Common Use Cases

### 1. Hotel Booking Calendar

Perfect for accommodation booking with availability periods and restrictions:

<Source
  code={JSON.stringify({
    displayMode: 'popup',
    visibleMonths: 2,
    selectionMode: 'range',
    showSubmitButton: true,
    showSelectionAlert: true,
    defaultLayer: 'Availability',
    layers: [
      {
        name: 'Availability',
        title: 'Room Availability',
        description: 'Available booking periods',
        visible: true,
        data: {
          background: [
            {
              startDate: '2024-01-15',
              endDate: '2024-01-20',
              color: '#D1FAE5' // Available
            },
            {
              startDate: '2024-02-05',
              endDate: '2024-02-10',
              color: '#D1FAE5' // Available
            }
          ],
          events: [
            {
              date: '2024-01-15',
              title: 'Deluxe Suite Available',
              type: 'available',
              time: 'Check-in 3PM',
              description: '$299/night',
              color: '#059669'
            }
          ]
        }
      }
    ],
    restrictionConfig: {
      restrictions: [
        {
          type: 'boundary',
          enabled: true,
          date: new Date().toISOString().split('T')[0],
          direction: 'before',
          message: 'Cannot book past dates'
        }
      ]
    }
  }, null, 2)}
  language="json"
/>

### 2. Medical Appointment Scheduler

Single-date selection with business hours restrictions:

<Source
  code={JSON.stringify({
    displayMode: 'embedded',
    visibleMonths: 1,
    selectionMode: 'single',
    showSubmitButton: true,
    showSelectionAlert: true,
    restrictionConfig: {
      restrictions: [
        {
          type: 'weekday',
          enabled: true,
          days: [0, 6], // Block weekends
          message: 'Appointments only available weekdays'
        },
        {
          type: 'boundary',
          enabled: true,
          date: new Date().toISOString().split('T')[0],
          direction: 'before',
          message: 'Cannot schedule past appointments'
        }
      ]
    },
    layers: [
      {
        name: 'Appointments',
        title: 'Available Slots',
        visible: true,
        data: {
          events: [
            {
              date: '2024-01-15',
              title: '3 slots available',
              type: 'available',
              time: '9AM, 11AM, 2PM',
              color: '#059669'
            }
          ]
        }
      }
    ]
  }, null, 2)}
  language="json"
/>

### 3. Event Planning Calendar

Multi-layer system for different event types:

<Canvas>
  <Story of={EnhancedStories.EventTypesGallery} />
</Canvas>

<Source
  code={JSON.stringify({
    displayMode: 'popup',
    visibleMonths: 2,
    selectionMode: 'range',
    showLayersNavigation: true,
    showTooltips: true,
    defaultLayer: 'Meetings',
    layers: [
      {
        name: 'Meetings',
        title: 'Meetings & Calls',
        visible: true,
        data: {
          events: [
            {
              date: '2024-01-08',
              title: 'Client Call - TechCorp',
              type: 'meeting',
              time: '2:00 PM',
              description: 'Quarterly business review',
              color: '#1E40AF'
            }
          ]
        }
      },
      {
        name: 'Deadlines',
        title: 'Project Deadlines',
        visible: true,
        data: {
          events: [
            {
              date: '2024-01-19',
              title: 'Feature Freeze',
              type: 'deadline',
              time: '11:59 PM',
              description: 'No new features after this date',
              color: '#D97706'
            }
          ]
        }
      }
    ]
  }, null, 2)}
  language="json"
/>

### 4. Team Vacation Planner

Background colors to show team availability:

<Canvas>
  <Story of={LayerStories.BackgroundColors} />
</Canvas>

### 5. Conference Room Booking

Allowed ranges only for available time slots:

<Canvas>
  <Story of={RestrictionStories.AllowedRangesOnly} />
</Canvas>

---

## Integration Patterns

### React Hook Form Integration

<Source
  code={`import { useForm, Controller } from 'react-hook-form';
import { CLACalendar } from './CLACalendar';

function BookingForm() {
  const { control, handleSubmit } = useForm();

  const onSubmit = (data) => {
    console.log('Selected dates:', data.dateRange);
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <Controller
        name="dateRange"
        control={control}
        render={({ field }) => (
          <CLACalendar
            settings={{
              displayMode: 'popup',
              selectionMode: 'range',
              showSubmitButton: true
            }}
            onSubmit={(startDate, endDate) => {
              field.onChange({ startDate, endDate });
            }}
          />
        )}
      />
      <button type="submit">Book Now</button>
    </form>
  );
}`}
  language="jsx"
/>

### State Management with Redux

<Source
  code={`import { useSelector, useDispatch } from 'react-redux';
import { setSelectedDates, setCalendarOpen } from './calendarSlice';

function CalendarContainer() {
  const dispatch = useDispatch();
  const { selectedRange, isOpen, availableDates } = useSelector(state => state.calendar);

  return (
    <CLACalendar
      settings={{
        displayMode: 'popup',
        isOpen,
        selectionMode: 'range',
        layers: [
          {
            name: 'Available',
            title: 'Available Dates',
            visible: true,
            data: {
              background: availableDates.map(range => ({
                startDate: range.start,
                endDate: range.end,
                color: '#D1FAE5'
              }))
            }
          }
        ]
      }}
      onSubmit={(startDate, endDate) => {
        dispatch(setSelectedDates({ startDate, endDate }));
        dispatch(setCalendarOpen(false));
      }}
    />
  );
}`}
  language="jsx"
/>

### Custom Validation Logic

<Source
  code={`function ValidatedCalendar() {
  const [customRestrictions, setCustomRestrictions] = useState([]);

  // Dynamic restriction based on business logic
  useEffect(() => {
    // Fetch blackout dates from API
    fetchBlackoutDates().then(dates => {
      const restrictions = dates.map(date => ({
        type: 'daterange',
        enabled: true,
        ranges: [{
          start: date,
          end: date,
          message: 'Date unavailable due to maintenance'
        }]
      }));
      setCustomRestrictions(restrictions);
    });
  }, []);

  return (
    <CLACalendar
      settings={{
        displayMode: 'popup',
        selectionMode: 'range',
        showSelectionAlert: true,
        restrictionConfig: {
          restrictions: customRestrictions
        }
      }}
      onSubmit={(startDate, endDate) => {
        // Additional validation
        if (isValidBookingPeriod(startDate, endDate)) {
          processBooking(startDate, endDate);
        } else {
          showError('Invalid booking period');
        }
      }}
    />
  );
}`}
  language="jsx"
/>

---

## Performance Optimization Patterns

### Lazy Loading Layers

<Source
  code={`function LazyCalendar() {
  const [layers, setLayers] = useState([]);
  const [loading, setLoading] = useState(false);

  const loadLayerData = async (layerName) => {
    setLoading(true);
    try {
      const data = await fetchLayerData(layerName);
      setLayers(prev => prev.map(layer => 
        layer.name === layerName 
          ? { ...layer, data }
          : layer
      ));
    } finally {
      setLoading(false);
    }
  };

  return (
    <CLACalendar
      settings={{
        displayMode: 'popup',
        showLayersNavigation: true,
        layers: layers,
        defaultLayer: 'Events'
      }}
      layersFactory={() => layers}
      onLayerChange={loadLayerData}
    />
  );
}`}
  language="jsx"
/>

### Memoized Configuration

<Source
  code={`import { useMemo } from 'react';

function OptimizedCalendar({ events, restrictions, theme }) {
  const calendarSettings = useMemo(() => ({
    displayMode: 'popup',
    visibleMonths: 2,
    selectionMode: 'range',
    showTooltips: true,
    layers: [
      {
        name: 'Events',
        title: 'Calendar Events',
        visible: true,
        data: { events }
      }
    ],
    restrictionConfig: { restrictions },
    colors: theme
  }), [events, restrictions, theme]);

  return <CLACalendar settings={calendarSettings} />;
}`}
  language="jsx"
/>

---

## Accessibility Patterns

### Keyboard Navigation Support

<Source
  code={JSON.stringify({
    displayMode: 'embedded',
    visibleMonths: 1,
    selectionMode: 'range',
    showTooltips: true,
    // Accessibility features are built-in:
    // - Arrow key navigation
    // - Enter/Space for selection
    // - Escape to close popup
    // - Screen reader support
    // - Focus management
    ariaLabels: {
      calendar: 'Date picker calendar',
      nextMonth: 'Go to next month',
      prevMonth: 'Go to previous month',
      selectDate: 'Select this date'
    }
  }, null, 2)}
  language="json"
/>

### High Contrast Mode

<Source
  code={JSON.stringify({
    displayMode: 'popup',
    colors: {
      primary: '#0066CC',
      success: '#006600',
      warning: '#CC6600',
      danger: '#CC0000'
    },
    // Additional accessibility settings
    highContrast: true,
    reducedMotion: true
  }, null, 2)}
  language="json"
/>

---

## Testing Patterns

### Unit Testing Configuration

<Source
  code={`import { render, screen, fireEvent } from '@testing-library/react';
import { CLACalendar } from './CLACalendar';

describe('CLACalendar', () => {
  const defaultSettings = {
    displayMode: 'embedded',
    visibleMonths: 1,
    selectionMode: 'range',
    isOpen: true
  };

  it('renders with basic configuration', () => {
    render(<CLACalendar settings={defaultSettings} />);
    expect(screen.getByRole('grid')).toBeInTheDocument();
  });

  it('handles date selection', () => {
    const onSubmit = jest.fn();
    render(
      <CLACalendar 
        settings={defaultSettings} 
        onSubmit={onSubmit}
      />
    );
    
    const dateButton = screen.getByRole('button', { name: /15/ });
    fireEvent.click(dateButton);
    
    expect(onSubmit).toHaveBeenCalledWith('2024-01-15', '2024-01-15');
  });

  it('respects restrictions', () => {
    const settingsWithRestrictions = {
      ...defaultSettings,
      restrictionConfig: {
        restrictions: [{
          type: 'weekday',
          enabled: true,
          days: [0, 6],
          message: 'Weekends blocked'
        }]
      }
    };

    render(<CLACalendar settings={settingsWithRestrictions} />);
    
    // Test that weekend dates are disabled
    const sundayButton = screen.getByRole('button', { name: /7/ });
    expect(sundayButton).toHaveAttribute('aria-disabled', 'true');
  });
});`}
  language="jsx"
/>

### E2E Testing with Cypress

<Source
  code={`describe('Calendar Booking Flow', () => {
  it('completes a booking with date restrictions', () => {
    cy.visit('/booking');
    
    // Open calendar
    cy.get('[data-testid="calendar-trigger"]').click();
    
    // Try to select a restricted date
    cy.get('[data-date="2024-01-01"]').click();
    cy.contains('Holiday - no bookings allowed').should('be.visible');
    
    // Select valid dates
    cy.get('[data-date="2024-01-15"]').click();
    cy.get('[data-date="2024-01-17"]').click();
    
    // Submit selection
    cy.get('[data-testid="submit-dates"]').click();
    
    // Verify booking
    cy.contains('Booking confirmed').should('be.visible');
  });
});`}
  language="javascript"
/>

---

## Migration Guide

### From v1.x to v2.x

<Source
  code={`// Old v1.x API
<Calendar 
  mode="range"
  months={2}
  popup={true}
  onSelect={(dates) => console.log(dates)}
/>

// New v2.x API
<CLACalendar 
  settings={{
    selectionMode: 'range',
    visibleMonths: 2,
    displayMode: 'popup'
  }}
  onSubmit={(startDate, endDate) => console.log(startDate, endDate)}
/>`}
  language="jsx"
/>

### Breaking Changes

1. **API Structure**: Settings are now grouped under a `settings` prop
2. **Event Names**: `onSelect` → `onSubmit`
3. **Prop Names**: `mode` → `selectionMode`, `months` → `visibleMonths`
4. **Layer System**: New feature requiring configuration update
5. **Restrictions**: New comprehensive restriction system

### Migration Checklist

- [ ] Update prop structure to use `settings` object
- [ ] Change `onSelect` to `onSubmit`
- [ ] Update prop names to new convention
- [ ] Add layer configuration if using events/backgrounds
- [ ] Update restriction configuration if using date validation
- [ ] Test keyboard navigation and accessibility
- [ ] Update TypeScript types if using TypeScript

---

## Best Practices

### 1. Performance
- Use `useMemo` for complex settings objects
- Implement lazy loading for large datasets
- Limit the number of visible months (2-3 max recommended)

### 2. User Experience
- Always provide clear restriction messages
- Use consistent color schemes across layers
- Enable tooltips for complex data
- Provide keyboard navigation support

### 3. Accessibility
- Ensure sufficient color contrast
- Provide meaningful aria labels
- Test with screen readers
- Support keyboard navigation

### 4. Testing
- Test with various date ranges
- Verify restriction logic
- Test layer switching functionality
- Validate form integration